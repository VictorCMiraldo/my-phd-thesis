%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                                                            %%
%% Package ``hs-digems Forest''                                               %%
%%                                                                            %%
%% Provides a set of definitions for 'forest' enviromentt that make the       %%
%% drawing of hs-digems patches easy.                                         %%
%%                                                                            %%
%% Version: v0.0.1                                                            %%
%% Authors: Victor Cacciari Miraldo                                           %%
%% License: MIT License (c) 2019 Victor Cacciari Miraldo                      %%
%% GitHub Repo: https://github.com/VictorCMiraldo/my-phd-thesis               %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{hs-digems-forest}[2019/05/23 hs-digems Forest]

\RequirePackage{forest}
\RequirePackage{tikz}
\RequirePackage{xcolor}

\ProcessOptions\relax

\usetikzlibrary{fit}
\usetikzlibrary{backgrounds}
\usetikzlibrary{positioning}

%%old: \definecolor{forest-digems-metavar}{RGB}{171,72,46}
%%darker: \definecolor{forest-digems-metavar}{RGB}{108,40,23}
%%purple:\definecolor{forest-digems-metavar}{RGB}{56,25,110}
\definecolor{forest-digems-metavar}{RGB}{0,112,33}

\definecolor{forest-digems-constr}{RGB}{80,88,113}
\definecolor{forest-digems-change-bg}{RGB}{220,224,238}
\definecolor{forest-digems-black}{RGB}{97,108,132}
\definecolor{forest-digems-change-border}{RGB}{0,112,33}

\definecolor{delctx-bg}{RGB}{240,190,190}
\definecolor{delctx-border}{RGB}{205,81,81}

\newcommand{\digemFormatMetavar}[1]{\ensuremath{\#_{#1}}}
\newcommand{\digemFormatMetavarKappaFam}[2]{\ensuremath{\#^{#1}_{#2}}}

%% This was based on: https://tex.stackexchange.com/questions/342334/drawing-super-nodes-in-a-tree 
\forestset{%
  debug=nodewalks,
  default preamble={%
      for tree={text=forest-digems-constr, 
                edge=forest-digems-black},
    },
  metavar/.style={%
    text=forest-digems-metavar,
    %% delay is crucial here; otherwise the default content
    %% is used. See manual page 6!
    delay={content/.wrap pgfmath arg={%
       \digemFormatMetavar{##1}
     }{content()}}
   },
  triang/.style={%
      shape=regular polygon,
      regular polygon sides=3,
      text=forest-digems-black,
      draw=forest-digems-black,
      font=\itshape,
      minimum width=1.3em,
      inner sep=0pt,
    },
  widen/.style n args={1}{%
    text=forest-digems-black,
    s sep=#1mm,
   },
  change/.style={%
    text=forest-digems-black,
    s sep=4mm,
    for 1={fit=band,no edge},
    for 2={fit=band,no edge},
    before typesetting nodes={%
      no edge,
      before computing xy={/pgf/inner ysep/.get=\savedinnerysep, 
                           l'=\savedinnerysep,
                           l=-1.8mm,
                           for 1={l=2mm},
                           for 2={l=2mm}
                           },
      replace by/.wrap pgfmath arg={%
        [\phantom{##1} , append, fit=rectangle, no edge,
          before drawing tree={%
            tikz+={%
              \begin{scope}[on background layer]
                \node (n) [ %fill=forest-digems-change-bg, 
                           inner sep=\savedinnerysep, 
                           dashed, draw=forest-digems-change-border,
                           rounded corners, fit to=tree] {}; 
                \path [draw=forest-digems-black, \forestoption{edge}] 
                           (!u.parent anchor) -- (n.north -| !1.child anchor)
                           \forestoption{edge label};
              \end{scope}
            },
          },
        ]
      }{content()}
    },
    tikz+={ \node (m1) at ($ (!1)!0.5!(!2) $) {}; 
            \node (m2) at ($ (m1) $)          {};
            \node [text=forest-digems-black] at ($ (m1)!0.5!(m2) $) {$\mapsto$};
          },
  },
  rootchange/.style={%
    text=forest-digems-black,
    s sep=4mm,
    for 1={fit=band,no edge},
    for 2={fit=band,no edge},
    before typesetting nodes={%
      no edge,
      before computing xy={/pgf/inner ysep/.get=\savedinnerysep, 
                           l'=\savedinnerysep,
                           l=-1.8mm,
                           for 1={l=2mm},
                           for 2={l=2mm}},
      replace by/.wrap pgfmath arg={%
        [\phantom{##1} , append, fit=rectangle, no edge,
          before drawing tree={%
            tikz+={%
              \begin{scope}[on background layer]
                \node (n) [ %fill=forest-digems-change-bg, 
                           inner sep=\savedinnerysep, 
                           dashed, draw=forest-digems-change-border,
                           rounded corners, fit to=tree] {}; 
              \end{scope}
            },
          },
        ]
      }{content()}
    },
    tikz+={ \node (m1) at ($(!1)!0.5!(!2)$) {}; 
            \node (m2) at ($(m1)$)          {};
            \node [text=forest-digems-black] at ($(m1)!0.5!(m2)$) {$\mapsto$};
          },
  },
  rootchange clean/.style n args={1}{%
    text=forest-digems-black,
    s sep=#1mm,
    for 1={fit=band,no edge},
    for 2={fit=band,no edge},
    before typesetting nodes={%
      no edge,
      before computing xy={/pgf/inner ysep/.get=\savedinnerysep, 
                           l'=\savedinnerysep,
                           l=-1.8mm,
                           for 1={l=2mm},
                           for 2={l=2mm}},
    },
  },
%%%%%%%%%%%% 
  delctx/.style n args={1}{%
    text=forest-digems-black,
    edge=forest-digems-black,
    before typesetting nodes={%
      tikz+={\begin{scope}[on background layer]
               \node (n) [ fill=delctx-bg
                         , draw=delctx-border
                         , rounded corners
                         , fit=(!first)(!last)(!c)] {};
             \end{scope}
            },
    },
    for #1={replace by={%
      [$\square$ 
        , text=forest-digems-black
        , edge=forest-digems-black
        , append
      ]}},
  },
}

\endinput